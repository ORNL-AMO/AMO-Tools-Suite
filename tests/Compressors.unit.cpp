#include "catch.hpp"
#include <calculator/util/Compressors.h>

TEST_CASE( "Calculate estimated power(kW) consumption and air flow(acfm) for a Compressor based on control type", "[Power-Flow-Calculations]" ) {
    auto ccBlow = Compressors_Centrifugal_BlowOff(452.3, 3138, 370.9, 2510);
    auto resBOff = ccBlow.calculateFromPerkW_BlowOff(0.82, 0.6798);
    CHECK(resBOff.kW_Calc == Approx(370.886));
    CHECK(resBOff.C_Calc == Approx(376.788));
    CHECK(resBOff.PerkW == Approx(0.82));
    CHECK(resBOff.C_Per == Approx(0.120073));
    CHECK(resBOff.C_blow == Approx(2133.21));
    CHECK(resBOff.blowPer == Approx(0.6798));
    resBOff = ccBlow.calculateFromPerC_BlowOff(0.01);
    CHECK(resBOff.kW_Calc == Approx(370.9));
    CHECK(resBOff.C_Calc == Approx(31.38));
    CHECK(resBOff.PerkW == Approx(0.820031));
    CHECK(resBOff.C_Per == Approx(0.01));
    CHECK(resBOff.C_blow == Approx(2478.62));
    CHECK(resBOff.blowPer == Approx(0.789873));
    resBOff = ccBlow.calculateFromkWMeasured_BlowOff(370.9, 0.6798);
    CHECK(resBOff.kW_Calc == Approx(370.9));
    CHECK(resBOff.C_Calc == Approx(376.788));
    CHECK(resBOff.PerkW == Approx(0.8200309));
    CHECK(resBOff.C_Per == Approx(0.120073));
    CHECK(resBOff.C_blow == Approx(2133.21));
    CHECK(resBOff.blowPer == Approx(0.6798));
    resBOff = ccBlow.calculateFromCMeasured_BlowOff(31.38);
    CHECK(resBOff.kW_Calc == Approx(370.9));
    CHECK(resBOff.C_Calc == Approx(31.38));
    CHECK(resBOff.PerkW == Approx(0.820031));
    CHECK(resBOff.C_Per == Approx(0.01));
    CHECK(resBOff.C_blow == Approx(2478.62));
    CHECK(resBOff.blowPer == Approx(0.789873));
    resBOff = ccBlow.calculateFromVIPFMeasured_BlowOff(440, 0.02152, 50, 0.6798);
    CHECK(resBOff.kW_Calc == Approx(370.885));
    CHECK(resBOff.C_Calc == Approx(376.788));
    CHECK(resBOff.PerkW == Approx(0.82));
    CHECK(resBOff.C_Per == Approx(0.120073));
    CHECK(resBOff.C_blow == Approx(2133.21));
    CHECK(resBOff.blowPer == Approx(0.6798));

    ccBlow.AdjustDischargePressure({3200, 3138, 2885}, {91, 100, 117}, 100);
    resBOff = ccBlow.calculateFromPerkW_BlowOff(0.82, 0.6798);
    CHECK(resBOff.kW_Calc == Approx(370.886));
    CHECK(resBOff.C_Calc == Approx(376.788));
    CHECK(resBOff.PerkW == Approx(0.82));
    CHECK(resBOff.C_Per == Approx(0.120073));
    CHECK(resBOff.C_blow == Approx(2133.21));
    CHECK(resBOff.blowPer == Approx(0.6798));
    resBOff = ccBlow.calculateFromPerC_BlowOff(0.01);
    CHECK(resBOff.kW_Calc == Approx(370.9));
    CHECK(resBOff.C_Calc == Approx(31.38));
    CHECK(resBOff.PerkW == Approx(0.820031));
    CHECK(resBOff.C_Per == Approx(0.01));
    CHECK(resBOff.C_blow == Approx(2478.62));
    CHECK(resBOff.blowPer == Approx(0.789873));
    resBOff = ccBlow.calculateFromkWMeasured_BlowOff(370.9, 0.6798);
    CHECK(resBOff.kW_Calc == Approx(370.9));
    CHECK(resBOff.C_Calc == Approx(376.788));
    CHECK(resBOff.PerkW == Approx(0.8200309));
    CHECK(resBOff.C_Per == Approx(0.120073));
    CHECK(resBOff.C_blow == Approx(2133.21));
    CHECK(resBOff.blowPer == Approx(0.6798));
    resBOff = ccBlow.calculateFromCMeasured_BlowOff(31.38);
    CHECK(resBOff.kW_Calc == Approx(370.9));
    CHECK(resBOff.C_Calc == Approx(31.38));
    CHECK(resBOff.PerkW == Approx(0.820031));
    CHECK(resBOff.C_Per == Approx(0.01));
    CHECK(resBOff.C_blow == Approx(2478.62));
    CHECK(resBOff.blowPer == Approx(0.789873));
    resBOff = ccBlow.calculateFromVIPFMeasured_BlowOff(440, 0.02152, 50, 0.6798);
    CHECK(resBOff.kW_Calc == Approx(370.885));
    CHECK(resBOff.C_Calc == Approx(376.788));
    CHECK(resBOff.PerkW == Approx(0.82));
    CHECK(resBOff.C_Per == Approx(0.120073));
    CHECK(resBOff.C_blow == Approx(2133.21));
    CHECK(resBOff.blowPer == Approx(0.6798));


    auto cclUL = Compressors_Centrifugal_LoadUnload(452.3, 3138, 71.3);
    auto resLul = cclUL.calculateFromPerkW(0.36);
    CHECK(resLul.kW_Calc == Approx(162.828));
    CHECK(resLul.C_Calc == Approx(753.8448));
    CHECK(resLul.PerkW == Approx(0.36));
    CHECK(resLul.C_Per == Approx(0.24023));
    resLul = cclUL.calculateFromPerC(0.24);
    CHECK(resLul.kW_Calc == Approx(162.74));
    CHECK(resLul.C_Calc == Approx(753.12));
    CHECK(resLul.PerkW == Approx(0.3598));
    CHECK(resLul.C_Per == Approx(0.24));
    resLul = cclUL.calculateFromkWMeasured(162.828);
    CHECK(resLul.kW_Calc == Approx(162.828));
    CHECK(resLul.C_Calc == Approx(753.8448));
    CHECK(resLul.PerkW == Approx(0.36));
    CHECK(resLul.C_Per == Approx(0.24023));
    resLul = cclUL.calculateFromCMeasured(753.12);
    CHECK(resLul.kW_Calc == Approx(162.74));
    CHECK(resLul.C_Calc == Approx(753.12));
    CHECK(resLul.PerkW == Approx(0.3598));
    CHECK(resLul.C_Per == Approx(0.24));
    resLul = cclUL.calculateFromVIPFMeasured(440,0.00945,50);
    CHECK(resLul.kW_Calc == Approx(162.865));
    CHECK(resLul.C_Calc == Approx(754.1532));
    CHECK(resLul.PerkW == Approx(0.3600828));
    CHECK(resLul.C_Per == Approx(0.24033));

    cclUL.AdjustDischargePressure({3200, 3138, 2885}, {91, 100, 117}, 100);
    resLul = cclUL.calculateFromPerkW(0.36);
    CHECK(resLul.kW_Calc == Approx(162.828));
    CHECK(resLul.C_Calc == Approx(753.8448));
    CHECK(resLul.PerkW == Approx(0.36));
    CHECK(resLul.C_Per == Approx(0.24023));
    resLul = cclUL.calculateFromPerC(0.24);
    CHECK(resLul.kW_Calc == Approx(162.74));
    CHECK(resLul.C_Calc == Approx(753.12));
    CHECK(resLul.PerkW == Approx(0.3598));
    CHECK(resLul.C_Per == Approx(0.24));
    resLul = cclUL.calculateFromkWMeasured(162.828);
    CHECK(resLul.kW_Calc == Approx(162.828));
    CHECK(resLul.C_Calc == Approx(753.84478));
    CHECK(resLul.PerkW == Approx(0.36));
    CHECK(resLul.C_Per == Approx(0.24023));
    resLul = cclUL.calculateFromCMeasured(753.12);
    CHECK(resLul.kW_Calc == Approx(162.74));
    CHECK(resLul.C_Calc == Approx(753.12));
    CHECK(resLul.PerkW == Approx(0.3598));
    CHECK(resLul.C_Per == Approx(0.24));
    resLul = cclUL.calculateFromVIPFMeasured(440,0.00945,50);
    CHECK(resLul.kW_Calc == Approx(162.865));
    CHECK(resLul.C_Calc == Approx(754.15323));
    CHECK(resLul.PerkW == Approx(0.3600828));
    CHECK(resLul.C_Per == Approx(0.24033));

    auto ccMuL = Compressors_Centrifugal_ModulationUnload(452.3, 3138, 71.3, 3005, 411.9, 2731);
    auto resMuL = ccMuL.calculateFromPerkW(0.94);
    CHECK(resMuL.kW_Calc == Approx(425.162));
    CHECK(resMuL.C_Calc == Approx(2820.95));
    CHECK(resMuL.PerkW == Approx(0.94));
    CHECK(resMuL.C_Per == Approx(0.93875));
    resMuL = ccMuL.calculateFromPerC(0.24);
    CHECK(resMuL.kW_Calc == Approx(165.226));
    CHECK(resMuL.C_Calc == Approx(753.12));
    CHECK(resMuL.PerkW == Approx(0.365302));
    CHECK(resMuL.C_Per == Approx(0.24));
    resMuL = ccMuL.calculateFromkWMeasured(425.162);
    CHECK(resMuL.kW_Calc == Approx(425.162));
    CHECK(resMuL.C_Calc == Approx(2820.95));
    CHECK(resMuL.PerkW == Approx(0.94));
    CHECK(resMuL.C_Per == Approx(0.93875));
    resMuL = ccMuL.calculateFromCMeasured(753.12);
    CHECK(resMuL.kW_Calc == Approx(165.226));
    CHECK(resMuL.C_Calc == Approx(753.12));
    CHECK(resMuL.PerkW == Approx(0.365302));
    CHECK(resMuL.C_Per == Approx(0.24));
    resMuL = ccMuL.calculateFromVIPFMeasured(440, 0.02467, 50);
    CHECK(resMuL.kW_Calc == Approx(425.174));
    CHECK(resMuL.C_Calc == Approx(2821.02));
    CHECK(resMuL.PerkW == Approx(0.940026));
    CHECK(resMuL.C_Per == Approx(0.938777));

    ccMuL.AdjustDischargePressure({3200, 3138, 2885}, {91, 100, 117}, 100, 58.23);
    resMuL = ccMuL.calculateFromPerkW(0.94);
    CHECK(resMuL.kW_Calc == Approx(425.162));
    CHECK(resMuL.C_Calc == Approx(2820.95));
    CHECK(resMuL.PerkW == Approx(0.94));
    CHECK(resMuL.C_Per == Approx(0.93875));
    resMuL = ccMuL.calculateFromPerC(0.24);
    CHECK(resMuL.kW_Calc == Approx(165.226));
    CHECK(resMuL.C_Calc == Approx(753.12));
    CHECK(resMuL.PerkW == Approx(0.365302));
    CHECK(resMuL.C_Per == Approx(0.24));
    resMuL = ccMuL.calculateFromkWMeasured(425.162);
    CHECK(resMuL.kW_Calc == Approx(425.162));
    CHECK(resMuL.C_Calc == Approx(2820.95));
    CHECK(resMuL.PerkW == Approx(0.94));
    CHECK(resMuL.C_Per == Approx(0.93875));
    resMuL = ccMuL.calculateFromCMeasured(753.12);
    CHECK(resMuL.kW_Calc == Approx(165.226));
    CHECK(resMuL.C_Calc == Approx(753.12));
    CHECK(resMuL.PerkW == Approx(0.365302));
    CHECK(resMuL.C_Per == Approx(0.24));
    resMuL = ccMuL.calculateFromVIPFMeasured(440, 0.02467, 50);
    CHECK(resMuL.kW_Calc == Approx(425.174));
    CHECK(resMuL.C_Calc == Approx(2821.02));
    CHECK(resMuL.PerkW == Approx(0.940026));
    CHECK(resMuL.C_Per == Approx(0.938777));


    auto cMWOuL = Compressors_ModulationWOUnload(85.4, 473, 55.3);
    auto resMWOuL = cMWOuL.calculateFromPerkW(0.89);
    CHECK(resMWOuL.kW_Calc == Approx(76.006));
    CHECK(resMWOuL.C_Calc == Approx(325.38));
    CHECK(resMWOuL.PerkW == Approx(0.89));
    CHECK(resMWOuL.C_Per == Approx(0.6879));
    resMWOuL = cMWOuL.calculateFromPerC(1.66173);
    CHECK(resMWOuL.kW_Calc == Approx(105.31807));
    CHECK(resMWOuL.C_Calc == Approx(786));
    CHECK(resMWOuL.PerkW == Approx(1.2332327));
    CHECK(resMWOuL.C_Per == Approx(1.66173));
    resMWOuL = cMWOuL.calculateFromkWMeasured(75.9);
    CHECK(resMWOuL.kW_Calc == Approx(75.9));
    CHECK(resMWOuL.C_Calc == Approx(323.7142857143));
    CHECK(resMWOuL.PerkW == Approx(0.88875));
    CHECK(resMWOuL.C_Per == Approx(0.68438));
    resMWOuL = cMWOuL.calculateFromCMeasured(786);
    CHECK(resMWOuL.kW_Calc == Approx(105.31818));
    CHECK(resMWOuL.C_Calc == Approx(786));
    CHECK(resMWOuL.PerkW == Approx(1.23326));
    CHECK(resMWOuL.C_Per == Approx(1.66173));
    resMWOuL = cMWOuL.calculateFromVIPFMeasured(440, 0.02467, 50);
    CHECK(resMWOuL.kW_Calc == Approx(80.278));
    CHECK(resMWOuL.C_Calc == Approx(392.51));
    CHECK(resMWOuL.PerkW == Approx(0.94002));
    CHECK(resMWOuL.C_Per == Approx(0.82984));

    cMWOuL.Pressure_InletCorrection(473, 105, 1.4, 100, 14.5, 0.917, 110, 110, 14.7, true, 14.7);
    CHECK(cMWOuL.kW_fl_Adjusted == Approx(90.0736));
    CHECK(cMWOuL.C_fl_Adjusted == Approx(469.46));

    resMWOuL = cMWOuL.calculateFromPerkW(0.89);
    CHECK(resMWOuL.kW_Calc == Approx(80.16551));
    CHECK(resMWOuL.C_Calc == Approx(335.697));
    CHECK(resMWOuL.PerkW == Approx(0.89));
    CHECK(resMWOuL.C_Per == Approx(0.71506));
    resMWOuL = cMWOuL.calculateFromPerC(1.66173);
    CHECK(resMWOuL.kW_Calc == Approx(113.0843));
    CHECK(resMWOuL.C_Calc == Approx(780.116));
    CHECK(resMWOuL.PerkW == Approx(1.25547));
    CHECK(resMWOuL.C_Per == Approx(1.66173));
    resMWOuL = cMWOuL.calculateFromkWMeasured(75.9);
    CHECK(resMWOuL.kW_Calc == Approx(75.9));
    CHECK(resMWOuL.C_Calc == Approx(278.1105));
    CHECK(resMWOuL.PerkW == Approx(0.8426441883));
    CHECK(resMWOuL.C_Per == Approx(0.5924));
    resMWOuL = cMWOuL.calculateFromCMeasured(786);
    CHECK(resMWOuL.kW_Calc == Approx(113.52002));
    CHECK(resMWOuL.C_Calc == Approx(786));
    CHECK(resMWOuL.PerkW == Approx(1.260302));
    CHECK(resMWOuL.C_Per == Approx(1.67426));
    resMWOuL = cMWOuL.calculateFromVIPFMeasured(440, 0.02467, 50);
    CHECK(resMWOuL.kW_Calc == Approx(84.6715));
    CHECK(resMWOuL.C_Calc == Approx(396.53024));
    CHECK(resMWOuL.PerkW == Approx(0.94002568));
    CHECK(resMWOuL.C_Per == Approx(0.844665));

    auto cSS = Compressors_StartStop(89.5, 560, 1.05, 1);
    auto resSS = cSS.calculateFromPerkW(0.205);
    CHECK(resSS.kW_Calc == Approx(18.3475));
    CHECK(resSS.C_Calc == Approx(112));
    CHECK(resSS.PerkW == Approx(0.205));
    CHECK(resSS.C_Per == Approx(0.2));
    resSS = cSS.calculateFromPerC(0.2);
    CHECK(resSS.kW_Calc == Approx(18.3475));
    CHECK(resSS.C_Calc == Approx(112));
    CHECK(resSS.PerkW == Approx(0.205));
    CHECK(resSS.C_Per == Approx(0.2));
    resSS = cSS.calculateFromkWMeasured(18.35);
    CHECK(resSS.kW_Calc == Approx(18.35));
    CHECK(resSS.C_Calc == Approx(112.015));
    CHECK(resSS.PerkW == Approx(0.20502));
    CHECK(resSS.C_Per == Approx(0.200027));
    resSS = cSS.calculateFromCMeasured(112);
    CHECK(resSS.kW_Calc == Approx(18.3475));
    CHECK(resSS.C_Calc == Approx(112));
    CHECK(resSS.PerkW == Approx(0.205));
    CHECK(resSS.C_Per == Approx(0.2));
    resSS = cSS.calculateFromVIPFMeasured(440, 0.02467, 50);
    CHECK(resSS.kW_Calc == Approx(84.1323));
    CHECK(resSS.C_Calc == Approx(513.575));
    CHECK(resSS.PerkW == Approx(0.9400257));
    CHECK(resSS.C_Per == Approx(0.9171));

    cSS.Pressure_InletCorrection(473, 105, 1.4, 100, 14.5, 0.917, 110, 110,14.7, true, 14.7);
    CHECK(cSS.kW_fl_Adjusted == Approx(90.0736));
    CHECK(cSS.C_fl_Adjusted == Approx(469.46));

    resSS = cSS.calculateFromPerkW(0.205);
    CHECK(resSS.kW_Calc == Approx(18.46509));
    CHECK(resSS.C_Calc == Approx(93.891998291));
    CHECK(resSS.PerkW == Approx(0.205));
    CHECK(resSS.C_Per == Approx(0.2));
    resSS = cSS.calculateFromPerC(0.2);
    CHECK(resSS.kW_Calc == Approx(18.46501));
    CHECK(resSS.C_Calc == Approx(93.892));
    CHECK(resSS.PerkW == Approx(0.205));
    CHECK(resSS.C_Per == Approx(0.2));
    resSS = cSS.calculateFromkWMeasured(18.35);
    CHECK(resSS.kW_Calc == Approx(18.35));
    CHECK(resSS.C_Calc == Approx(93.3070665796));
    CHECK(resSS.PerkW == Approx(0.2037222774));
    CHECK(resSS.C_Per == Approx(0.1987534414));
    resSS = cSS.calculateFromCMeasured(112);
    CHECK(resSS.kW_Calc == Approx(22.0261988222));
    CHECK(resSS.C_Calc == Approx(112));
    CHECK(resSS.PerkW == Approx(0.2445355524));
    CHECK(resSS.C_Per == Approx(0.238572));
    resSS = cSS.calculateFromVIPFMeasured(440, 0.02467, 50);
    CHECK(resSS.kW_Calc == Approx(84.6715020437));
    CHECK(resSS.C_Calc == Approx(430.541));
    CHECK(resSS.PerkW == Approx(0.94002568));
    CHECK(resSS.C_Per == Approx(0.9170982244));

    auto cLUL = Compressors_LoadUnload(166.5, 1048, 175.5, 100, 110, 5, 14.7, Compressors::Screw, Compressors::Injected);
    auto resLUL = cLUL.calculateFromPerkW(0.94);
    CHECK(resLUL.kW_Calc == Approx(156.51));
    CHECK(resLUL.C_Calc == Approx(937.888));
    CHECK(resLUL.PerkW == Approx(0.94));
    CHECK(resLUL.C_Per == Approx(0.89493));
    resLUL = cLUL.calculateFromPerC(0.895);
    CHECK(resLUL.kW_Calc == Approx(156.442));
    CHECK(resLUL.C_Calc == Approx(937.96));
    CHECK(resLUL.PerkW == Approx(0.93959));
    CHECK(resLUL.C_Per == Approx(0.895));
    resLUL = cLUL.calculateFromkWMeasured(156);
    CHECK(resLUL.kW_Calc == Approx(156));
    CHECK(resLUL.C_Calc == Approx(933.857));
    CHECK(resLUL.PerkW == Approx(0.93693));
    CHECK(resLUL.C_Per == Approx(0.89108));
    resLUL = cLUL.calculateFromCMeasured(937);
    CHECK(resLUL.kW_Calc == Approx(156.322));
    CHECK(resLUL.C_Calc == Approx(937));
    CHECK(resLUL.PerkW == Approx(0.938872));
    CHECK(resLUL.C_Per == Approx(0.89408));
    resLUL = cLUL.calculateFromVIPFMeasured(440, 0.02467, 50);
    CHECK(resLUL.kW_Calc == Approx(156.514));
    CHECK(resLUL.C_Calc == Approx(937.922));
    CHECK(resLUL.PerkW == Approx(0.94002));
    CHECK(resLUL.C_Per == Approx(0.89496));

    auto cMUL = Compressors_ModulationWithUnload(166.5, 1048, 175.5, 107.5,100, 110, 5, 14.7);
    auto resMUL = cMUL.calculateFromPerkW(0.94);
    CHECK(resMUL.kW_Calc == Approx(156.51));
    CHECK(resMUL.C_Calc == Approx(937.888));
    CHECK(resMUL.PerkW == Approx(0.94));
    CHECK(resMUL.C_Per == Approx(0.89493));
    resMUL = cMUL.calculateFromPerC(0.895);
    CHECK(resMUL.kW_Calc == Approx(156.442));
    CHECK(resMUL.C_Calc == Approx(937.96));
    CHECK(resMUL.PerkW == Approx(0.93959));
    CHECK(resMUL.C_Per == Approx(0.895));
    resMUL = cMUL.calculateFromkWMeasured(156);
    CHECK(resMUL.kW_Calc == Approx(156));
    CHECK(resMUL.C_Calc == Approx(933.857));
    CHECK(resMUL.PerkW == Approx(0.93693));
    CHECK(resMUL.C_Per == Approx(0.89108));
    resMUL = cMUL.calculateFromCMeasured(937);
    CHECK(resMUL.kW_Calc == Approx(156.322));
    CHECK(resMUL.C_Calc == Approx(937));
    CHECK(resMUL.PerkW == Approx(0.938872));
    CHECK(resMUL.C_Per == Approx(0.89408));
    resMUL = cMUL.calculateFromVIPFMeasured(440, 0.02467, 50);
    CHECK(resMUL.kW_Calc == Approx(156.514));
    CHECK(resMUL.C_Calc == Approx(937.922));
    CHECK(resMUL.PerkW == Approx(0.94002));
    CHECK(resMUL.C_Per == Approx(0.89496));

    resMUL = cMUL.calculateFromPerC(0.97);
    CHECK(resMUL.kW_Calc == Approx(166.032));
    CHECK(resMUL.C_Calc == Approx(1016.56));
    CHECK(resMUL.PerkW == Approx(0.997188));
    CHECK(resMUL.C_Per == Approx(0.97));


    auto redAirLeak = CompressorEEMs::ReduceAirLeaks(473, 100, 10, 0.5);
    CHECK(redAirLeak.C_lkred == Approx(5));
    CHECK(redAirLeak.C_usage_lkred == Approx(95));
    CHECK(redAirLeak.PerC_lkred == Approx(0.20084));

    auto endUseEff = CompressorEEMs::ImproveEndUseEfficiency(473, 236, 20);
    CHECK(endUseEff.C_af_red == Approx(216));
    CHECK(endUseEff.CPer_af_red == Approx(0.45666));

    auto redAirPressure = CompressorEEMs::ReduceSystemAirPressure(473, 100, 100, 85.4, 5, 14.7,14.7);
    CHECK(redAirPressure.P_fl_rpred == Approx(95));
    CHECK(redAirPressure.kW_fl_rpadj == Approx(82.972));
    CHECK(redAirPressure.C_usage_rpred == Approx(97.384));
    CHECK(redAirPressure.PerC_rpred == Approx(0.2059));

    auto cascadingSetPoint = CompressorEEMs::AdjustCascadingSetPoint(2578, 1000, 100, 414.4, 105, 14.7,14.7);
    CHECK(cascadingSetPoint.kW_fl_adj == Approx(425.82));
    CHECK(cascadingSetPoint.C_usage_adj == Approx(1026.16));
    CHECK(cascadingSetPoint.PerC_adj == Approx(0.39804313));
}

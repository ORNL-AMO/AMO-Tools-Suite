#language: cpp
language: node_js
node_js:
  - '12.8.0'
  
compiler:
  - gcc
  #- clang
  
matrix:
  include:
    - name: "Linux Build"
      os: linux
    
    - name: "Mac Build"
      os: osx
      
    - name: "Windows Build"
      os: windows

before_install:
  - |
    if [[ $TRAVIS_BRANCH == "master" ]]; then
      export PRODUCTION="master"
    fi
  - |
    if [[ $TRAVIS_OS_NAME == "linux" ]]; then
      sudo apt-get update
      sudo apt-get install -y make
      sudo apt-get install -y doxygen
    fi
  - |
    if [[ $TRAVIS_OS_NAME == "windows" ]]; then
      choco install make --yes
      choco install doxygen.install --yes
    fi
  - |
    if [[ $TRAVIS_OS_NAME == "osx" ]]; then
      bew update
      brew install make
      brew install doxygen
    fi
  
  - node --version
  #- doxygen --version

install:
  - travis_retry npm install
  #- node-gyp rebuild

script:
  - |
    if [[ $TRAVIS_BRANCH == $PRODUCTION ]]; then
      export PACKAGE="ON"
    else
      export PACKAGE="OFF"
    fi
  - ls -a
  - cmake -D BUILD_TESTING:BOOL=ON -D BUILD_PACKAGE:BOOL=$PACKAGE --config Release ./
  - cmake --build .
  - ls -a
  - |
    if [[ $TRAVIS_OS_NAME == "windows" ]]; then
      ./Release/amo_tools_suite_tests
    else
      ./bin/amo_tools_suite_tests
    fi
  - npm run test
  - npm run at
  - |
    if [[ $TRAVIS_OS_NAME == "windows" ]]; then
      echo "Skipping Doxygen"
    else
      doxygen Doxyfile.in
    fi
    - |
      if [[ $TRAVIS_BRANCH == $PRODUCTION ]]; then
        make package
      fi
    - ls

version: '3.8'

services:
  amo-tools-suite:
    build: .
    container_name: amo-tools-suite-build
    restart: always
    command:
      - /bin/sh
      - -c
      - |
        rm -rf /home/AMO-Tools-Suite/
        cp -r /AMO-Tools-Suite /home/AMO-Tools-Suite/
        
        mkdir -p /home/AMO-Tools-Suite/build-cpp/
        cd /home/AMO-Tools-Suite/build-cpp/
        cmake ..
        cmake --build . -j 8 
        
        mkdir -p /home/AMO-Tools-Suite/build-wasm/
        cd /home/AMO-Tools-Suite/build-wasm/
        source /home/emsdk/emsdk_env.sh
        emcmake cmake -D BUILD_WASM=ON ..
        emmake make -j 8
        
        cd /home/AMO-Tools-Suite/
        npm install
        npm run test-wasm-stop
        npm run test-wasm
    volumes:
      - ../AMO-Tools-Suite:/AMO-Tools-Suite
    ports:
      # - "127.0.0.1:3000:3000"
      - "3000:3000"
    networks:
      - ts-net

networks:
  ts-net:
    name: ts-build-network
